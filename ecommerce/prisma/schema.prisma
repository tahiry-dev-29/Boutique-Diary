generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Post {
  id        Int      @id @default(autoincrement())
  title     String   @db.VarChar(255)
  content   String?
  createdAt DateTime @default(now())
}

model User {
  id         Int              @id @default(autoincrement())
  username   String           @unique
  email      String           @unique
  password   String
  createdAt  DateTime         @default(now())
  isActive   Boolean          @default(true)
  role       Role             @default(CUSTOMER)
  updatedAt  DateTime         @updatedAt
  photo      String?
  points     Int              @default(0)
  addresses  Address[]
  carts      Cart[]
  orders     Order[]
  reviews    Review[]
  reactions  ReviewReaction[]
  replies    ReviewReply[]
  wishlist   WishlistItem[]
  promoCodes PromoCode[]
}

model Product {
  id              Int                @id @default(autoincrement())
  name            String             @db.VarChar(255)
  description     String?
  reference       String             @unique @db.VarChar(100)
  price           Float
  stock           Int                @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  categoryId      Int?
  brand           String?            @db.VarChar(100)
  colors          String[]           @default([])
  isBestSeller    Boolean            @default(false)
  isNew           Boolean            @default(false)
  isPromotion     Boolean            @default(false)
  oldPrice        Float?
  rating          Float?             @default(0)
  reviewCount     Int                @default(0)
  sizes           String[]           @default([])
  deletedAt       DateTime?
  promotionRuleId Int?
  status          String             @default("DRAFT")
  blogPosts       BlogPost[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  category        Category?          @relation(fields: [categoryId], references: [id])
  promotionRule   PromotionRule?     @relation(fields: [promotionRuleId], references: [id])
  images          ProductImage[]
  variations      ProductVariation[]
  reviews         Review[]
  stockMovements  StockMovement[]
  wishlistedBy    WishlistItem[]
}

model Cart {
  id        String     @id @default(cuid())
  sessionId String?    @unique
  userId    Int?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User?      @relation(fields: [userId], references: [id])
  items     CartItem[]
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId Int
  quantity  Int      @default(1)
  color     String?
  size      String?
  price     Float
  createdAt DateTime @default(now())
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])

  @@index([cartId])
  @@index([productId])
}

model ProductVariation {
  id              Int            @id @default(autoincrement())
  sku             String         @unique
  productId       Int
  color           String?
  size            String?
  price           Decimal        @db.Decimal(10, 2)
  stock           Int            @default(0)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  oldPrice        Decimal?       @db.Decimal(10, 2)
  promotionRuleId Int?
  product         Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  promotionRule   PromotionRule? @relation(fields: [promotionRuleId], references: [id])

  @@unique([productId, color, size])
  @@index([sku])
  @@index([productId])
}

model ProductImage {
  id              Int             @id @default(autoincrement())
  url             String
  reference       String?         @db.VarChar(100)
  color           String?         @db.VarChar(50)
  sizes           String[]        @default([])
  price           Float?
  oldPrice        Float?
  stock           Int?
  productId       Int
  categoryId      Int?
  isNew           Boolean         @default(false)
  isPromotion     Boolean         @default(false)
  isBestSeller    Boolean         @default(false)
  promotionRuleId Int?
  blogPosts       BlogPost[]
  orderItems      OrderItem[]
  category        Category?       @relation(fields: [categoryId], references: [id])
  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  promotionRule   PromotionRule?  @relation(fields: [promotionRuleId], references: [id])
  stockMovements  StockMovement[]
}

model Category {
  id          Int            @id @default(autoincrement())
  name        String         @db.VarChar(255)
  description String?
  slug        String         @unique @db.VarChar(255)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  products    Product[]
  images      ProductImage[]
}

model SiteSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Banner {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(100)
  subtitle    String?  @db.VarChar(100)
  description String?
  buttonText  String?  @db.VarChar(50)
  buttonLink  String?  @db.VarChar(255)
  imageUrl    String
  order       Int      @default(1)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([order])
  @@index([isActive])
}

model Admin {
  id              Int              @id @default(autoincrement())
  name            String           @db.VarChar(100)
  email           String           @unique
  password        String
  role            String           @default("admin")
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  lastSeen        DateTime?
  isOnline        Boolean          @default(false)
  contactMessages ContactMessage[]
  reviewReactions ReviewReaction[]
  reviewReplies   ReviewReply[]
}

model StockMovement {
  id             Int           @id @default(autoincrement())
  productId      Int
  productImageId Int?
  type           String
  quantity       Int
  previousStock  Int
  newStock       Int
  reason         String?
  note           String?
  createdBy      String?
  createdAt      DateTime      @default(now())
  product        Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  productImage   ProductImage? @relation(fields: [productImageId], references: [id])

  @@index([productId])
  @@index([productImageId])
}

model Order {
  id           String               @id @default(cuid())
  reference    String               @unique
  total        Float
  status       String               @default("PENDING")
  customerId   Int?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  stockReduced Boolean              @default(false)
  discount     Float?               @default(0)
  promoCode    String?
  customer     User?                @relation(fields: [customerId], references: [id])
  items        OrderItem[]
  transactions PaymentTransaction[]
}

model OrderItem {
  id             String        @id @default(cuid())
  orderId        String
  productId      Int
  quantity       Int
  price          Float
  productImageId Int?
  order          Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product       @relation(fields: [productId], references: [id])
  productImage   ProductImage? @relation(fields: [productImageId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([productImageId])
}

model PaymentMethod {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  logoUrl     String?
  isActive    Boolean  @default(false)
  isDefault   Boolean  @default(false)
  config      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PaymentTransaction {
  id        String   @id @default(cuid())
  orderId   String
  amount    Float
  currency  String   @default("MGA")
  provider  String
  reference String?
  status    String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([reference])
  @@index([status])
}

model PromoCode {
  id             Int          @id @default(autoincrement())
  code           String       @unique @db.VarChar(50)
  type           DiscountType @default(PERCENTAGE)
  value          Float
  startDate      DateTime?
  endDate        DateTime?
  usageLimit     Int?
  usageCount     Int          @default(0)
  minOrderAmount Float?
  costPoints     Int? // Coût en points pour acheter ce code
  isActive       Boolean      @default(true)
  ownerId        Int? // Si défini, ce code appartient à un utilisateur spécifique
  owner          User?        @relation(fields: [ownerId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([ownerId])
  @@index([code])
  @@index([isActive])
}

model PromotionRule {
  id                Int                @id @default(autoincrement())
  name              String             @db.VarChar(255)
  priority          Int                @default(0)
  conditions        Json
  actions           Json
  startDate         DateTime?
  endDate           DateTime?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  products          Product[]
  productImages     ProductImage[]
  productVariations ProductVariation[]

  @@index([isActive])
}

model Review {
  id         Int              @id @default(autoincrement())
  rating     Float
  comment    String
  isVerified Boolean          @default(false)
  tags       Json?
  productId  Int
  userId     Int
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  product    Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactions  ReviewReaction[]
  replies    ReviewReply[]

  @@index([productId])
  @@index([userId])
}

model ReviewReply {
  id        Int      @id @default(autoincrement())
  content   String
  reviewId  Int
  adminId   Int?
  userId    Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  admin     Admin?   @relation(fields: [adminId], references: [id])
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([reviewId])
}

model ReviewReaction {
  id       Int    @id @default(autoincrement())
  type     String
  reviewId Int
  userId   Int?
  adminId  Int?
  admin    Admin? @relation(fields: [adminId], references: [id])
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user     User?  @relation(fields: [userId], references: [id])

  @@unique([reviewId, userId, adminId, type])
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    Int
  productId Int
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

model Address {
  id          String   @id @default(cuid())
  userId      Int
  label       String?
  street      String
  city        String
  postalCode  String
  country     String   @default("Madagascar")
  phoneNumber String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BlogPost {
  id              Int           @id @default(autoincrement())
  title           String        @db.VarChar(255)
  slug            String        @unique @db.VarChar(300)
  excerpt         String?
  content         String
  coverImage      String?
  productId       Int
  isPublished     Boolean       @default(false)
  viewCount       Int           @default(0)
  metaTitle       String?       @db.VarChar(255)
  metaDescription String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  publishedAt     DateTime?
  productImageId  Int?
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  productImage    ProductImage? @relation(fields: [productImageId], references: [id])

  @@index([productId])
  @@index([isPublished])
  @@index([slug])
}

model ContactMessage {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  email     String   @db.VarChar(255)
  phone     String?  @db.VarChar(50)
  message   String
  status    String   @default("UNREAD")
  adminId   Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  admin     Admin?   @relation(fields: [adminId], references: [id])

  @@index([status])
  @@index([email])
}

model StoreTheme {
  id                Int       @id @default(autoincrement())
  name              String    @default("My Theme") @db.VarChar(100)
  primaryColor      String    @default("#3d6b6b") @db.VarChar(9)
  primaryOpacity    Float     @default(1.0)
  primaryGradient   String?
  secondaryColor    String    @default("#d4b8a5") @db.VarChar(9)
  secondaryOpacity  Float     @default(1.0)
  secondaryGradient String?
  accentColor       String    @default("#c45a4a") @db.VarChar(9)
  fontHeading       String    @default("Playfair Display") @db.VarChar(100)
  fontBody          String    @default("Montserrat") @db.VarChar(100)
  backgroundColor   String    @default("#ffffff") @db.VarChar(9)
  textColor         String    @default("#111111") @db.VarChar(9)
  headerConfig      Json?
  heroConfig        Json?
  sectionsConfig    Json?
  stylePreset       String    @default("material") @db.VarChar(50)
  isActive          Boolean   @default(true)
  deletedAt         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

enum Role {
  CUSTOMER
  EMPLOYEE
  ADMIN
  SUPERADMIN
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}
